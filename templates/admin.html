{% extends "base2.html" %}

{% block content %}

<style>
/*.active{
    padding-left: 20px;
}

.tab-content{
    padding-left: 10px;
}

.error-message {
    margin: 10px;
    color: #db4437;
}*/

.error-message {
    color: red;
}

</style>


<body>

<!-- Modal for Admin Modification -->
<div id="modify-modal" class="modal fade" role="dialog">
    <div class="modal-dialog">
        <div class="modal-content">
            <form id="modify-form" name="editUser" method="POST">
                <input type="hidden" name="name-form" value="editUser"/>
                <div class="modal-header">
                    <h3 class="modal-title" id="modify-label">Reviewing Changes</h3>
                </div>

                <div class="modal-body">
                    <div class="container-fluid">
                      <div class="form-group">
                        <label for="sel1">Select list:</label>
                        <select class="form-control" id="sel1" name="role">
                          <option value="supervisor">supervisor</option>
                          <option value="runner">runner</option>

                        </select>
                      </div>
                        <p>You are modifying permissions for: <strong><input type="text" name="username" readonly></strong><br><span class="text-info">This action can be reversed at any time</span></p>
                    </div>
                </div>


                <div class="modal-footer">

                    <button type="submit" class="btn btn-success" id="modify-button">Apply</button>
                    <button type="button" data-dismiss="modal" class="btn btn-default">Close</button>

                </div>
            </form>
        </div>
    </div>
</div>
<!-- END of Modal View for Admin Modification -->


<div class="container">
<!-- Nav tabs -->
<ul class="nav nav-tabs" role="tablist">
    <li role="presentation" class="active"><a href="#users" aria-controls="users" role="tab" data-toggle="tab">Users</a></li>
    <li role="presentation"><a href="#item" aria-controls="item" role="tab" data-toggle="tab">Items</a></li>
    <li role="presentation"><a href="#group" aria-controls="group" role="tab" data-toggle="tab">Storerooms & Tags</a></li>
    <!-- <li role="presentation"><a href="#existitem" aria-controls="existitem" role="tab" data-toggle="tab">Assign Item to Tag</a></li> -->

</ul>

<div class="tab-content">

<!-- ******************* USERS TAB *****************************-->
         
    <div role="tabpanel" id="users" class="container-fluid tab-pane fade in active">
        <div class="row">
            <a href="#currentUsers" data-toggle="collapse"><h3>Current Users</h3></a>
            <div id="currentUsers" class="collapse">
                <div class="table-responsive">
                    <table class="table">
                        <thead>

                            <th>{{_('Username')}}</th>
                            <th>{{_('Name')}}</th>
                            <th>{{_('Role')}}</th>
                            <th>{{_('Edit')}}</th>
                            <th>{{_('Delete User')}}</th>
                        </thead>

                        <tbody>
                        {% for user in users %}
                        <tr>
                            <td>{{ user.name }}</td>
                            <td>{{ user.username }}</td>
                            <td>{{ user.role }}</td>
                            <td><button class="btn btn-default" style="margin-bottom: 5px;" data-toggle="modal" data-target="#modify-modal" data-name="{{ user.username }}" id="#modify">{{_('Edit')}}</button></td>
                            <td><button class="btn btn-danger" onclick="deleteUser('{{user.username}}')">&times;</button></td>
                        </tr>
                        {% endfor %}
                        </tbody>

                    </table>
                </div>
            </div>
        </div>
        
        <div class="row">
            <a href="#newUser" data-toggle="collapse"><h3>Add a New User</h3></a>
            <div id="newUser" class="collapse">
                <form method="POST" action="/{{g.current_lang}}/admin" >
                    {{ form.hidden_tag() }}
                    <input type="hidden" name="name-form" value='form')>


                    <div class="row form-group">
                        {{ form.name.label }}
                        {% if form.name.errors %}
                            {% for error in form.name.errors %}
                            <p class="error-message">{{ error }}</p>
                            {% endfor %}
                        {% endif %}

                        <div class="form-group">
                        {{ form.name(class="form-control", placeholder="Name of User")}}
                        </div>
                    </div>

                    <div class="row form-group">
                        {{ form.username.label }}
                        {% if form.username.errors %}
                            {% for error in form.username.errors %}
                            <p class="error-message">{{ error }}</p>
                            {% endfor %}
                        {% endif %}

                        <div class="form-group">
                        {{ form.username(class="form-control", placeholder="Username") }}
                        </div>
                    </div>


                    <div class="row form-group">
                        {{ form.password.label }}
                        {% if form.password.errors %}
                            {% for error in form.password.errors %}
                            <p class="error-message">{{ error }}</p>
                            {% endfor %}
                        {% endif %}

                        <div class="form-group">
                        {{ form.password(class="form-control", placeholder="Password") }}
                        </div>
                    </div>


                    <div class="row form-group">
                        {{ form.role.label }} <br>
                        {% for subfield in form.role %}
                            <tr>
                                <td>{{ subfield }}</td>
                                <td>{{ subfield.label }}</td>
                                <br>
                            </tr>
                        {% endfor %}
                    </div>
                    <br>

                    {{ form.submit(class="width-35 pull-right btn btn-sm btn-primary") }}

                </form>
            </div>
        </div>

    </div>



<!--#........................ ITEMS TAB .............................  -->

    <div role="tabpanel" id="item" class="container-fluid tab-pane fade">

        <div class="row">
            <a href="#newItem" data-toggle="collapse"><h3>Add a New Item</h3></a>
            <div id="newItem" class="collapse">
                <form method="POST" id="newItemForm" action="/{{g.current_lang}}/admin" enctype=multipart/form-data >{{ form2.hidden_tag() }}<input type="hidden"  name="name-form" value='form2' >

                    <div class="row form-group">
                        {{ form2.itemname.label }}
                        {% if form2.itemname.errors %}
                            {% for error in form2.itemname.errors %}
                            <p class="error-message">{{ error }}</p>
                            {% endfor %}
                        {% endif %}

                        <div id="add-item-name" class="form-group">
                        {{ form2.itemname(class="form-control", placeholder="Name of Item")}}
                        </div>
                    </div>

                    <div class="row form-group">
                        {{ form2.category.label }}
                        {% if form2.category.errors %}
                            {% for error in form2.category.errors %}
                            <p class="error-message">{{ error }}</p>
                            {% endfor %}
                        {% endif %}

                        <div class="form-group">
                        {{ form2.category(class="form-control")}}
                        </div>
                    </div>

                    <div class="row form-group">
                        <strong>Upload a Photo</strong>
                        <div class="input-group" style="margin-bottom: 20px;">
                            <label class="input-group-btn">
                                <span class="btn btn-default">
                                    Upload photo&hellip;<input type="file" accept="image/*" name="photo" style="display: none;">
                                </span>
                            </label>
                            <input type="text" class="form-control" readonly>
                        </div>
                    </div>

                    <div class="row form-group">
                        {{ form2.reorderpt.label }}
                        {% if form2.reorderpt.errors %}
                            {% for error in form2.reorderpt.errors %}
                            <p class="error-message">{{ error }}</p>
                            {% endfor %}
                        {% endif %}

                        <div class="form-group">
                        {{ form2.reorderpt(class="form-control", placeholder="Input Min. Stock") }}
                        </div>
                    </div>


                    <div class="row form-group">
                        {{ form2.price.label }}
                        {% if form2.price.errors %}
                            {% for error in form2.price.errors %}
                            <p class="error-message">{{ error }}</p>
                            {% endfor %}
                        {% endif %}

                        <div class="form-group">
                        {{ form2.price(class="form-control", placeholder="Unit Price") }}
                        </div>
                    </div>


                    <div class="row form-group">
                        {{ form2.count_unit.label }}
                        {% if form2.count_unit.errors %}
                            {% for error in form2.count_unit.errors %}
                            <p class="error-message">{{ error }}</p>
                            {% endfor %}
                        {% endif %}

                        <div id="add-item-name" class="form-group">
                        {{ form2.count_unit(class="form-control", placeholder="eg. carton, pc, kg")}}
                        </div>
                    </div>

                    <div class="row form-group">
                        {{ form2.order_unit.label }}
                        {% if form2.order_unit.errors %}
                            {% for error in form2.order_unit.errors %}
                            <p class="error-message">{{ error }}</p>
                            {% endfor %}
                        {% endif %}

                        <div id="add-item-name" class="form-group">
                        {{ form2.order_unit(class="form-control", placeholder="eg. carton, pc, kg")}}
                        </div>
                    </div>

                    <div class="row form-group">
                        {{ form2.order_multiplier.label }}
                        {% if form2.order_multiplier.errors %}
                            {% for error in form2.order_multiplier.errors %}
                            <p class="error-message">{{ error }}</p>
                            {% endfor %}
                        {% endif %}

                        <div class="form-group">
                        {{ form2.order_multiplier(class="form-control", placeholder="Items in each order") }}
                        </div>
                    </div>

                    {{ form2.submitTwo(class="width-35 pull-right btn btn-sm btn-primary") }}

                </form>
            </div>
        </div>

        <div class="row">
            <a href="#delItem" data-toggle="collapse"><h3>Delete an Item</h3></a>
            <div id="delItem" class="collapse">
                <form method="POST" id="delItemForm" action="/{{g.current_lang}}/admin" enctype=multipart/form-data >{{ removeItemForm.hidden_tag() }}<input type="hidden"  name="name-form" value='removeItemForm' >
                    <!-- Just placeholders for future delete group input -->
                    <div class="row form-group">
                        {{ removeItemForm.iname.label }}
                        {% if removeItemForm.iname.errors %}
                            {% for error in removeItemForm.iname.errors %}
                            <p class="error-message">{{ error }}</p>
                            {% endfor %}
                        {% endif %}
                        <div id="add-item-name" class="form-group">
                        {{ removeItemForm.iname(class="form-control typeahead", placeholder="Name of Item")}}
                        </div>
                    </div>

                    {{ removeItemForm.submit(class="width-35 pull-right btn btn-sm btn-primary") }}
                </form>
            </div>
        </div>

        <div class="row">
            <a href="#tagItem" data-toggle="collapse"><h3>Assign an Item to a Tag</h3></a>
            <div id="tagItem" class="collapse">
                <form method="POST" action="/{{g.current_lang}}/admin">
                    {{ form4.hidden_tag() }}
                    <input type="hidden"  name="name-form" value='form4'>
                    <h3> Assign Item to Tag</h3>


                    <div class="row form-group">
                        {{ form4.itemname.label }}
                        {% if form4.itemname.errors %}
                            {% for error in form4.itemname.errors %}
                            <p class="error-message">{{ error }}</p>
                            {% endfor %}
                        {% endif %}

                        <div id="add-item-name" class="form-group">
                        {{ form4.itemname(class="form-control typeahead", placeholder="Name of Existing Item", style="width: 100%;")}}
                        </div>
                    </div>


                    <div class="row form-group">
                        {{ form4.tid.label }}
                        {% if form4.tid.errors %}
                            {% for error in form4.tid.errors %}
                            <p class="error-message">{{ error }}</p>
                            {% endfor %}
                        {% endif %}

                        <div class="form-group">
                            {{ form4.tid(class="form-control") }}
                        </div>
                    </div>


                    <div class="row form-group">
                        {{ form4.qty.label }}
                        {% if form4.qty.errors %}
                            {% for error in form4.qty.errors %}
                            <p class="error-message">{{ error }}</p>
                            {% endfor %}
                        {% endif %}

                        <div class="form-group">
                        {{ form4.qty(class="form-control", placeholder="Quantity Available") }}
                        </div>
                    </div>


                    {{ form4.submitFour(class="width-35 pull-right btn btn-sm btn-primary") }}

                </form>
            </div>
        </div>

        <div class="row">
            <a href="#transferItem" data-toggle="collapse"><h3>Transfer an Item</h3></a>
            <div id="transferItem" class="collapse">
                <form method="POST" id="transItemForm" action="/{{g.current_lang}}/admin" enctype=multipart/form-data >{{ transferItemForm.hidden_tag() }}<input type="hidden"  name="name-form" value='transferItemForm' >
                    <div class="row form-group">
                        {{ transferItemForm.iname.label }}
                        {% if transferItemForm.iname.errors %}
                            {% for error in transferItemForm.iname.errors %}
                            <p class="error-message">{{ error }}</p>
                            {% endfor %}
                        {% endif %}
                        <div id="add-item-name" class="form-group">
                            <input type="text" class="form-control typeahead" name="iname" placeholder="Name of Item" id="itemSelect" value="" />
                        </div>
                    </div>

                    <div class="row form-group">
                        {{ transferItemForm.tagOld.label }}
                        {% if transferItemForm.tagOld.errors %}
                            {% for error in transferItemForm.tagOld.errors %}
                            <p class="error-message">{{ error }}</p>
                            {% endfor %}
                        {% endif %}
                        <div class="form-group" id="tagOldDiv">
                            {{ transferItemForm.tagOld(class="form-control", placeholder="Select a Tag") }}
                        </div>
                    </div>

                    <div class="row form-group">
                        {{ transferItemForm.tagNew.label }}
                        {% if transferItemForm.tagNew.errors %}
                            {% for error in transferItemForm.tagNew.errors %}
                            <p class="error-message">{{ error }}</p>
                            {% endfor %}
                        {% endif %}
                        <div class="form-group">
                            {{ transferItemForm.tagNew(class="form-control") }}
                        </div>
                    </div>

                    <div class="row form-group">
                        {{ transferItemForm.qty.label }}<br/>
                        If left blank, all of this item will be transferred.
                        {% if transferItemForm.qty.errors %}
                            {% for error in transferItemForm.qty.errors %}
                            <p class="error-message">{{ error }}</p>
                            {% endfor %}
                        {% endif %}

                        <div class="form-group">
                        {{ transferItemForm.qty(class="form-control", placeholder="Quantity to Transfer") }}
                        </div>
                    </div>


                    {{ transferItemForm.submit(class="width-35 pull-right btn btn-sm btn-primary") }}
                </form>
            </div>
        </div>

        <div class="row" style="font-size: medium;">
            <h3>Item List by Storeroom</h3>
            {% for key, values in group.iteritems() %}

            <!--find a way to create a button-->
            <a href="#{{key[0]}}" data-toggle="collapse" data-target="#{{ key[0] }}" aria-expanded="false" aria-controls="collapseExample"><strong>{{ key[1] }}</strong></a><br/>
            <div class="collapse" id="{{ key[0] }}">

                <ul class="list-group">

                    {% for i in values %}
                        <li class="list-group-item" style="overflow-y: auto;">
                            <a href="/{{g.current_lang}}/inventory/{{i[1]}}"> {{ i[0].encode('ascii') }}, {{i[2]}} </a>
                            <span style="cursor:pointer;color: red;" onclick="removeFromTag({{i[1]}}, {{key[0]}})" class="pull-right hidden-xs">Remove from tag</span>
                            <span class="pull-right visible-xs" style="color: red;">&times;</span>
                        </li>

                    {% endfor %}


                </ul>

            </div>

            {% endfor %}
        </div>

    </div>

<!--#........................ TAGS TAB .............................  -->
    <div role="tabpanel" id="group" class="container-fluid tab-pane fade">
        <div class="row">
            <a href="#newTag" data-toggle="collapse"><h3>Add a New Tag</h3></a>
            <div id="newTag" class="collapse">
                <form method="POST" action="/{{g.current_lang}}/admin">
                    {{ form.hidden_tag() }}
                    <input type="hidden"  name="name-form" value='form3' >

                    <div class="row">

                        <div class="row form-group col-lg-5 col-md-5 col-sm-12 col-xs-12">
                            {{ form3.location.label }}
                            {% if form3.location.errors %}
                                {% for error in form3.location.errors %}
                                <p class="error-message">{{ error }}</p>
                                {% endfor %}
                            {% endif %}

                            <div class="form-group">
                            {{ form3.location(class="form-control")}}
                            </div>
                        </div>

                        <div class="row form-group col-lg-1 col-md-1 col-sm-12 col-xs-12" style="text-align:center;">
                            <strong>or</strong>
                        </div>

                        <div class="row form-group col-lg-5 col-md-5 col-sm-12 col-xs-12">
                            {{ form3.newLocation.label }}
                            {% if form3.newLocation.errors %}
                                {% for error in form3.newLocation.errors %}
                                <p class="error-message">{{ error }}</p>
                                {% endfor %}
                            {% endif %}

                            <div class="form-group">
                            {{ form3.newLocation(class="form-control", placeholder="Name of New Storeroom")}}
                            </div>
                        </div>
                    </div>

                    <div class="row form-group">
                        {{ form3.tname.label }}
                        {% if form3.tname.errors %}
                            {% for error in form3.tname.errors %}
                            <p class="error-message">{{ error }}</p>
                            {% endfor %}
                        {% endif %}

                        <div class="form-group">
                        {{ form3.tname(class="form-control", placeholder="Name of new tag")}}
                        </div>
                    </div>



                    <div class="row form-group">
                        {{ form3.remarks.label }}

                        <div class="form-group">
                        {{ form3.remarks(class="form-control", placeholder="Remarks (optional)")}}
                        </div>
                    </div>

                    {{ form3.submitThree(class="width-35 pull-right btn btn-sm btn-primary") }}

                </form>
            </div>
        </div>

        <div class="row">
            <a href="#delTag" data-toggle="collapse"><h3>Delete a Tag</h3></a>
            <div id="delTag" class="collapse">
                <form method="POST" id="delItemForm" action="/{{g.current_lang}}/admin" enctype=multipart/form-data >{{ removeTagForm.hidden_tag() }}<input type="hidden"  name="name-form" value='removeTagForm' >
                    <div class="row form-group">
                        {{ removeTagForm.tid.label }}
                        {% if removeTagForm.tid.errors %}
                            {% for error in removeTagForm.tid.errors %}
                            <p class="error-message">{{ error }}</p>
                            {% endfor %}
                        {% endif %}
                        <div class="form-group">
                        {{ removeTagForm.tid(class="form-control") }}
                        </div>
                    </div>

                    {{ removeTagForm.submit(class="width-35 pull-right btn btn-sm btn-primary") }}
                </form>
            </div>
        </div>
        
    </div>

</div>

</div>

<script>
$(function() {

  // Attach the `fileselect` event to all file inputs on the page
  $(document).on('change', ':file', function() {
    var input = $(this),
        numFiles = input.get(0).files ? input.get(0).files.length : 1,
        label = input.val().replace(/\\/g, '/').replace(/.*\//, '');
    input.trigger('fileselect', [numFiles, label]);
  });

  // Watch for our custom `fileselect` event
  $(document).ready( function() {
      $(':file').on('fileselect', function(event, numFiles, label) {

          var input = $(this).parents('.input-group').find(':text'),
              log = numFiles > 1 ? numFiles + ' files selected' : label;

          if( input.length ) {
              input.val(log);
          } else {
              if( log ) alert(log);
          }

      });
  });

});

// Filter storerooms by item
$("#itemSelect").change(function(){
    var item = $("#itemSelect").val();
    var list = JSON.parse(fixEncoding("{{ itemTags }}"));
    var parseList = JSON.parse(fixEncoding("{{tagsByStore}}"));
    var dict = {};
    for (var p in parseList) {
        dict[parseList[p][0]] = parseList[p][1];
    }
    tagList = [];
    // console.log(list);

    // Makes a list of tag ids that the item is associated with.
    for(var l in list) {
        console.log(list[l]);
        if (list[l][0] == item) {
            tagList.push(list[l][1]);
        }
    }


    $("#tagOldDiv select option").each(function() {
        $(this).hide();
        console.log($(this).val());
        for (var i in tagList) {
            if ($(this).val() == tagList[i]) {
                $(this).show();
                $(this).attr('selected', 'selected');
            }
        }
    })
    // Creates a new option in tagOld for each tag that the item is associated with.
    // $("#tagOldDiv select").html('');
    // for (var i in tagList) {
    //     var newOption = document.createElement("option");
    //     newOption.value = tagList[i];
    //     newOption.innerHTML = dict[tagList[i]];
    //     console.log(newOption)
    //     $("#tagOldDiv select").append(newOption);
    //     console.log(dict[tagList[i]]);
    // }

});


// Fixes .NET 4.0 bug where symbols are replaced with HTML keycodes.
function fixEncoding(str) {
    s = str.replace(/&amp;/g, "&").replace(/&#(\d+);/g, function(match, number) {
        return String.fromCharCode(number);
    });
    return s;
}

function storeChangeListener(storeroom) {
     $("#"+storeroom).change(function() {
        filterTags(storeroom);
    });

}


var substringMatcher = function(strs) {
  return function findMatches(q, cb) {
    var matches, substringRegex;

    // an array that will be populated with substring matches
    matches = [];

    // regex used to determine if a string contains the substring `q`
    substrRegex = new RegExp(q, 'i');

    // iterate through the pool of strings and for any string that
    // contains the substring `q`, add it to the `matches` array
    $.each(strs, function(i, str) {
      if (substrRegex.test(str)) {
        matches.push(str);
      }
    });

    cb(matches);
  };
};

var all_items = {{ item_list|safe }};

$('#add-item-name .typeahead').typeahead({
  hint: true,
  highlight: true,
  minLength: 1
},
{
  name: 'all_items',
  source: substringMatcher(all_items)
});

// <!-- Modal changes---->
$('#modify-modal').on('show.bs.modal', function (event) {
  var button = $(event.relatedTarget); // Button that triggered the modal
  var admin = button.data('name'); // Extract info from data-* attributes
  // If necessary, you could initiate an AJAX request here (and then do the updating in a callback).
  // Update the modal's content. We'll use jQuery here, but you could use a data binding library or other methods instead.
  var modal = $(this);
  modal.find('.modal-title').text('Reviewing changes to ' + admin);
  modal.find('.modal-body input').val(admin);
})

function deleteUser(username) {
    var form = document.createElement('form');
    var input = document.createElement('input');
    var formName = document.createElement('input');

    formName.value = 'deleteUser';
    formName.name = 'name-form';
    form.appendChild(formName);

    input.value = username;
    input.name = "username";
    form.appendChild(input);

    form.method = "POST";

    document.body.appendChild(form);
    form.submit();
}

function removeFromTag(item, tag) {
    console.log(item, tag);
    var form = document.createElement('form');
    var input1 = document.createElement('input');
    var input2 = document.createElement('input');
    var formName = document.createElement('input');

    formName.value = 'removeFromTag';
    formName.name = 'name-form';
    formName.type = "hidden";
    form.appendChild(formName);

    input1.value = item;
    input1.name = "iid";
    input1.type = "hidden";
    form.appendChild(input1);

    input2.value = tag;
    input2.name = "tid";
    input2.type = "hidden";
    form.appendChild(input2);

    form.method = "POST";

    document.body.appendChild(form);
    form.submit();
}

</script>


</body>
{% endblock %}
